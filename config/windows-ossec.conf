<!--
  Wazuh Agent Configuration - Windows Client (Windows Server 2022/2025)
  Project: Atelier Sécurité des Endpoints et Supervision SIEM
  
  This configuration file enables comprehensive EDR capabilities including:
  - Windows Event Log collection (Security, System, Application)
  - Sysmon integration for enhanced process monitoring
  - File Integrity Monitoring (FIM)
  - Security Configuration Assessment
  - System inventory
-->

<ossec_config>
  
  <!-- Client Configuration -->
  <client>
    <server>
      <address>WAZUH_MANAGER_IP</address>
      <port>1514</port>
      <protocol>tcp</protocol>
    </server>
    <config-profile>windows</config-profile>
    <notify_time>10</notify_time>
    <time-reconnect>60</time-reconnect>
    <auto_restart>yes</auto_restart>
    <crypto_method>aes</crypto_method>
  </client>

  <!-- Buffer Configuration -->
  <client_buffer>
    <disabled>no</disabled>
    <queue_size>5000</queue_size>
    <events_per_second>500</events_per_second>
  </client_buffer>

  <!-- File Integrity Monitoring (FIM) -->
  <syscheck>
    <disabled>no</disabled>
    
    <!-- Scan frequency (every 12 hours) -->
    <frequency>43200</frequency>
    
    <!-- Critical Windows directories - Real-time monitoring -->
    <directories check_all="yes" realtime="yes" report_changes="yes">C:\Windows\System32</directories>
    <directories check_all="yes" realtime="yes">C:\Windows\SysWOW64</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">C:\Program Files</directories>
    <directories check_all="yes" realtime="yes">C:\Program Files (x86)</directories>
    
    <!-- Startup locations -->
    <directories check_all="yes" realtime="yes">C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup</directories>
    <directories check_all="yes" realtime="yes">C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</directories>
    
    <!-- Monitor Windows directory but with restrictions -->
    <directories check_all="yes">C:\Windows</directories>
    
    <!-- Ignore temporary and cache files -->
    <ignore>C:\Windows\Temp</ignore>
    <ignore>C:\Windows\System32\config</ignore>
    <ignore>C:\Windows\SoftwareDistribution</ignore>
    <ignore>C:\Windows\System32\wbem\Performance</ignore>
    <ignore>C:\Windows\System32\sru</ignore>
    <ignore type="sregex">\AppData\Local\Temp</ignore>
    <ignore type="sregex">\.log$|\.tmp$|\.etl$</ignore>
    
    <!-- Windows registry monitoring -->
    <windows_registry>HKEY_LOCAL_MACHINE\Software</windows_registry>
    <windows_registry>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services</windows_registry>
    <windows_registry>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\KnownDLLs</windows_registry>
    <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run</windows_registry>
    <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce</windows_registry>
    <windows_registry arch="both">HKEY_USERS\.DEFAULT\Software\Microsoft\Windows\CurrentVersion\Run</windows_registry>
    
    <!-- Registry entries to ignore -->
    <registry_ignore>HKEY_LOCAL_MACHINE\Security\Policy\Secrets</registry_ignore>
    <registry_ignore>HKEY_LOCAL_MACHINE\Security\SAM\Domains\Account\Users</registry_ignore>
    <registry_ignore type="sregex">\Enum$</registry_ignore>
    
    <scan_on_start>yes</scan_on_start>
    <recursion_level>256</recursion_level>
    <database>disk</database>
    
    <synchronization>
      <enabled>yes</enabled>
      <interval>5m</interval>
      <max_interval>1h</max_interval>
      <response_timeout>30</response_timeout>
      <queue_size>16384</queue_size>
      <max_eps>10</max_eps>
    </synchronization>
  </syscheck>

  <!-- Rootkit Detection -->
  <rootcheck>
    <disabled>no</disabled>
    <windows_apps>yes</windows_apps>
    <windows_malware>yes</windows_malware>
    <frequency>43200</frequency>
  </rootcheck>

  <!-- Security Configuration Assessment -->
  <sca>
    <enabled>yes</enabled>
    <scan_on_start>yes</scan_on_start>
    <interval>12h</interval>
    <skip_nfs>yes</skip_nfs>
  </sca>

  <!-- Windows Event Log Collection -->
  
  <!-- Security Events (Authentication, Account Management, etc.) -->
  <localfile>
    <location>Security</location>
    <log_format>eventchannel</log_format>
    <query>Event/System[EventID != 5145 and EventID != 5156 and EventID != 4656 and EventID != 4658 and EventID != 4663 and EventID != 4660 and EventID != 4670 and EventID != 4690 and EventID != 4703 and EventID != 4907]</query>
  </localfile>

  <!-- System Events -->
  <localfile>
    <location>System</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- Application Events -->
  <localfile>
    <location>Application</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- Windows Defender Events -->
  <localfile>
    <location>Microsoft-Windows-Windows Defender/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- PowerShell Events (Script Block Logging) -->
  <localfile>
    <location>Microsoft-Windows-PowerShell/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- Windows Firewall Events -->
  <localfile>
    <location>Microsoft-Windows-Windows Firewall With Advanced Security/Firewall</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- **SYSMON INTEGRATION - Enhanced EDR Telemetry** -->
  <!-- Sysmon provides detailed process execution, network connections, file creation, etc. -->
  <localfile>
    <location>Microsoft-Windows-Sysmon/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- Task Scheduler Events -->
  <localfile>
    <location>Microsoft-Windows-TaskScheduler/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- WMI Events -->
  <localfile>
    <location>Microsoft-Windows-WMI-Activity/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- AppLocker Events (if enabled) -->
  <localfile>
    <location>Microsoft-Windows-AppLocker/EXE and DLL</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- RDP Connection Events -->
  <localfile>
    <location>Microsoft-Windows-TerminalServices-RemoteConnectionManager/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <localfile>
    <location>Microsoft-Windows-TerminalServices-LocalSessionManager/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- DNS Client Events -->
  <localfile>
    <location>Microsoft-Windows-DNS-Client/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- Active Response -->
  <active-response>
    <disabled>no</disabled>
    <ca_store>wpk_root.pem</ca_store>
    <ca_verification>yes</ca_verification>
  </active-response>

  <!-- System Inventory Collection -->
  <wodle name="syscollector">
    <disabled>no</disabled>
    <interval>1h</interval>
    <scan_on_start>yes</scan_on_start>
    <hardware>yes</hardware>
    <os>yes</os>
    <network>yes</network>
    <packages>yes</packages>
    <ports all="no">yes</ports>
    <processes>yes</processes>
    
    <!-- Windows-specific options -->
    <hotfixes>yes</hotfixes>
  </wodle>

  <!-- CIS-CAT Integration (if available) -->
  <wodle name="cis-cat">
    <disabled>yes</disabled>
    <timeout>1800</timeout>
    <interval>1d</interval>
    <scan-on-start>yes</scan-on-start>
    <java_path>wodles\java</java_path>
    <ciscat_path>wodles\ciscat</ciscat_path>
  </wodle>

  <!-- Osquery Integration (if installed) -->
  <wodle name="osquery">
    <disabled>yes</disabled>
    <run_daemon>yes</run_daemon>
    <log_path>C:\Program Files\osquery\log\osqueryd.results.log</log_path>
    <config_path>C:\Program Files\osquery\osquery.conf</config_path>
    <add_labels>yes</add_labels>
  </wodle>

  <!-- Vulnerability Detector -->
  <wodle name="vulnerability-detector">
    <disabled>no</disabled>
    <interval>5m</interval>
    <run_on_start>yes</run_on_start>
    <ignore_time>6h</ignore_time>
  </wodle>

  <!-- Agent Labels for Classification -->
  <labels>
    <label key="environment">production</label>
    <label key="os">windows</label>
    <label key="project">wazuh-siem-edr-lab</label>
    <label key="sysmon">enabled</label>
  </labels>

  <!-- Log Analysis Options -->
  <logging>
    <log_format>plain</log_format>
  </logging>

</ossec_config>

<!--
  IMPORTANT NOTES:
  
  1. Replace WAZUH_MANAGER_IP with your actual Wazuh server private IP address
  
  2. Sysmon Integration:
     - Sysmon must be installed separately: https://docs.microsoft.com/sysinternals/downloads/sysmon
     - Use SwiftOnSecurity config: https://github.com/SwiftOnSecurity/sysmon-config
     - After installing Sysmon, restart Wazuh agent: NET STOP WazuhSvc && NET START WazuhSvc
  
  3. Key Sysmon Event IDs collected:
     - Event ID 1: Process creation (with full command line and hashes)
     - Event ID 3: Network connection
     - Event ID 5: Process terminated
     - Event ID 7: Image (DLL) loaded
     - Event ID 8: CreateRemoteThread (injection technique)
     - Event ID 10: ProcessAccess (process manipulation)
     - Event ID 11: FileCreate
     - Event ID 12/13/14: Registry operations
     - Event ID 22: DNS query
  
  4. Critical Windows Event IDs monitored:
     - 4624: Successful logon
     - 4625: Failed logon (brute force detection)
     - 4672: Special privileges assigned (admin login)
     - 4720: User account created
     - 4722: User account enabled
     - 4724: Password reset attempt
     - 4732: Member added to security-enabled local group
     - 4688: Process creation
     - 4698: Scheduled task created
     - 4776: NTLM authentication
  
  5. Performance considerations:
     - Sysmon generates high volume of events
     - Adjust eps (events per second) if needed
     - Use registry_ignore and ignore to reduce noise
  
  6. After modifying this config:
     - Stop agent: NET STOP WazuhSvc
     - Start agent: NET START WazuhSvc
     - Check logs: C:\Program Files (x86)\ossec-agent\ossec.log
-->